$(function(){login()||(location.href="login.html");var t=getCookie("token"),e=api.getUser(t);$('.radio[name="type"]').click(function(){var e=$(this).val();"self"===e?($(".serCon").hide(),$("#self").show()):"door"===e&&($(".serCon").hide(),$("#door").show())});var d,l=[],s=[];function a(e,i){$.ajax({"type":"POST","url":url+"/api/v1/system/image-upload","dataType":"json","contentType":!1,"processData":!1,"data":e,"success":function(e){200===e.code&&i(e.data)},"error":function(){}})}function n(e){$(".deviceChild").html(""),$.ajax({"type":"GET","url":url+"/api/v1/category/get?id="+e,"dataType":"json","success":function(e){if(200===e.code){var i=e.data.children;if(0===i.length)return void $(".deviceChild").hide();i.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".deviceChild").append(a),$(".deviceChild").show("")})}},"error":function(){}})}function o(e){$(".faultChild").html(""),$.ajax({"type":"GET","url":url+"/api/v1/category/get?id="+e,"dataType":"json","success":function(e){if(200===e.code){var i=e.data.children;if(0===i.length)return void $(".faultChild").hide();i.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".faultChild").append(a),$(".faultChild").show("")})}},"error":function(){}})}$("#self .file").change(function(){var i=$(this),e=new FormData;e.append("file",$(this).get(0).files[0]),a(e,function(e){i.parent().find(".imgshow").attr("src",e[0].url),i.parent().find(".imgshow").attr("data-name",e[0].id),l.push(e[0].id)})}),$("#door .file").change(function(){var i=$(this),e=new FormData;e.append("file",$(this).get(0).files[0]),a(e,function(e){i.parent().find(".imgshow").attr("src",e[0].url),i.parent().find(".imgshow").attr("data-name",e[0].id),s.push(e[0].id)})}),$.ajax({"type":"GET","url":url+"/api/v1/category/index?type=device&parent_id=0","dataType":"json","success":function(e){200===e.code&&e.data.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".device").append(a),0===i&&n(e.id)})},"error":function(){}}),$(".device").bind("change",function(){n($(this).find("option:selected").val())}),$.ajax({"type":"GET","url":url+"/api/v1/category/index?type=fault&parent_id=0","dataType":"json","success":function(e){200===e.code&&e.data.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".fault").append(a),0===i&&o(e.id)})},"error":function(){}}),$(".fault").bind("change",function(){o($(this).find("option:selected").val())}),api.getRepairInfo(e.phone,function(e){var i=e.device_infos,a=e.coupon_infos;0!==i.length&&i.forEach(function(e,i){var a;a=0===i?"checked":"";var n='<p><input type="radio" name="addrS" class="device4" id="s'+i+'" value="'+e.id+'" checked="'+a+'"><label for="s'+i+'"><span>型号：'+e.goods_name+" 价格："+e.school_price+" </span></label></p>",o='<p><input type="radio" name="addrD" class="device4" id="d'+i+'" value="'+e.id+'" checked="'+a+'"><label for="d'+i+'"><span>型号：'+e.goods_name+" 价格："+e.school_price+" </span></label></p>";$("#self .sku_id").append(n),$("#door .sku_id").append(o)}),0!==a.length&&($("#user_coupon_id").html(""),a.forEach(function(e,i){var a;"n"===e.used&&(a=isEnglish()?'<a href="javascript:;" class="ticket1" data-name="'+e.id+'">\n                        <div class="up">\n                            <div class="img"></div>\n                            <p>'+e.type+'</p>\n                        </div>\n                        <div class="down">\n                            <p>Unused</p>\n                        </div>\n                    </a>':'<a href="javascript:;" class="ticket1" data-name="'+e.id+'">\n                        <div class="up">\n                            <div class="img"></div>\n                            <p>'+{"repair":"维修券"}[e.type]+'</p>\n                        </div>\n                        <div class="down">\n                            <p>未使用</p>\n                        </div>\n                    </a>'),$("#user_coupon_id").append(a)}))}),$("#user_coupon_id").on("click",".ticket1",function(){$(".ticket1").removeClass("active"),$(this).addClass("active"),d=$(this).attr("data-name")}),$(".submit").click(function(){var e={},i=[],a=[],n=$('#type input[name="type"]:checked').val();if("self"===n){i.push($("#self .device option:selected").val()),i.push($("#self .deviceChild option:selected").val()),a.push($("#self .fault option:selected").val()),a.push($("#self .faultChild option:selected").val());var o=$("#self .phone").val();if(!CheckMobile(o))return void(isEnglish()?$(".error").html("Phone format is incorrect."):$(".error").html("手机格式不正确."));e={"token":t,"type":n,"device_category":i.join(","),"fault_category":a.join(","),"phone":o,"lang":i18nLanguage},0<l.length&&(e.img_ids=l.join(",")),0<$("#self .param").val().length&&(e.param=$("#self .param").val()),0<$("#self .description").val().length&&(e.description=$("#self .description").val()),0<$("#self .email").val().length&&(e.email=$("#self .email").val()),$("#self .sku_id").has("input")&&(e.sku_id=$('#self .sku_id input[name="addrS"]:checked').val())}else{i.push($("#door .device option:selected").val()),i.push($("#door .deviceChild option:selected").val()),a.push($("#door .fault option:selected").val()),a.push($("#door .faultChild option:selected").val());o=$("#door .phone").val();if(!CheckMobile(o))return void(isEnglish()?$(".error").html("Phone format is incorrect."):$(".error").html("手机格式不正确."));e={"token":t,"type":n,"device_category":i.join(","),"fault_category":a.join(","),"phone":o,"lang":i18nLanguage},0<s.length&&(e.img_ids=s.join(",")),0<$("#door .param").val().length&&(e.param=$("#door .param").val()),0<$("#door .description").val().length&&(e.description=$("#door .description").val()),0<$("#door .email").val().length&&(e.email=$("#door .email").val()),""!==d&&(e.user_coupon_id=d),$("#door .sku_id").has("input")&&(e.sku_id=$('#door .sku_id input[name="addrD"]:checked').val())}$.ajax({"type":"POST","url":url+"/api/v1/repair/create","dataType":"json","data":e,"success":function(e){200===e.code?(isEnglish()?$(".error").html("Submitted successfully."):$(".error").html("提交成功。"),setTimeout(function(){$(".solution .content,.solution .title").hide(),$(".success").show(),$(".success .order_no span").html(e.data.repair_no)},1e3)):(isEnglish(),$(".error").html(e.msg))},"error":function(){}})})});