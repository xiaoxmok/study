$(function(){login()&&(location.href="index.html");getCookie("token");function e(){var e=$("#schoolSearch").children("option:selected").val();null==e&&(e=1),$("#schoolRegion").html(""),$.ajax({"type":"GET","url":url+"/api/v1/school-region/index?school_id="+e+"&lang="+i18nLanguage,"dataType":"json","success":function(e){if(200===e.code)for(var o=0;o<e.data.length;o++){var t='<option value="'+e.data[o].id+'">'+e.data[o].name+"</option>";$("#schoolRegion").append(t)}else{t='<option value="error">'+e.msg+"</option>";$("#schoolRegion").append(t),$(".error").html(e.msg)}},"error":function(e,o,t){console.log(e,o,t)}})}$.ajax({"type":"GET","url":url+"/api/v1/school/index?city=&lang="+i18nLanguage,"dataType":"json","success":function(e){if(200===e.code)for(var o=0;o<e.data.length;o++){var t='<option value="'+e.data[o].id+'">'+e.data[o].name+"</option>";$("#schoolSearch").append(t)}else{t='<option value="error">'+e.msg+"</option>";$("#schoolSearch").append(t),$(".error").html(e.msg)}},"error":function(e,o,t){console.log(e,o,t)}}),$("#schoolSearch").bind("change",function(){e()}),e();api.getCaptcha();$("#Captcha").attr("src","http://byod.1o24.com/api/v1/system/get-captcha"),$("#Captcha").click(function(){$("#Captcha").attr("src","http://byod.1o24.com/api/v1/system/get-captcha?t="+Math.random())}),$(".code").click(function(){var e,o;$(".error").html("");var t=$("#select").children("option:selected").val();if("phone"===t){if(e=$(".account").val(),!CheckMobile(e))return void(isEnglish()?$(".error").html("Account format is incorrect."):$(".error").html("账号格式不正确."));o={"verify_type":t,"phone":e}}else if("email"===t){if(e=$(".account").val(),!CheckEmail(e))return void(isEnglish()?$(".error").html("E-mail format is incorrect."):$(".error").html("邮箱格式不正确。"));o={"verify_type":t,"email":e}}var r=$(".Captcha_code").val();if(0!==r.length){o.captcha=r;var i,a=60;$.ajax({"type":"POST","url":url+"/api/v1/user/send-verify-code","dataType":"json","data":o,"success":function(e){200===e.code?($(".timeOut").html(a),i=setInterval(n,1e3),$(".code").hide(),$(".countDown").show()):$(".error").html(e.msg)},"error":function(e,o,t){console.log(e,o,t)}})}else isEnglish()?$(".error").html("Graphic verification code cannot be empty"):$(".error").html("图形验证码不能为空");function n(){a--,$(".timeOut").html(a),a<0&&(clearInterval(i),$(".code").show(),$(".countDown").hide(),a=10)}}),$(".register").click(function(){var l,e,o,t,r,i;$(".error").html("");var a=$("#select").children("option:selected").val();if(o=$(".valid_code").val(),CheckCode(o))if(e=$(".password").val(),CheckPwd(e)){if(t=$("#schoolSearch").children("option:selected").val(),"phone"===a){if(l=$(".account").val(),!CheckMobile(l))return void(isEnglish()?$(".error").html("Account format is incorrect."):$(".error").html("账号格式不正确."));r={"verify_type":a,"phone":l,"verify_code":o,"password":e,"school_id":t},i={"verify_type":a,"phone":l,"password":e}}else if("email"===a){if(l=$(".account").val(),!CheckEmail(l))return void(isEnglish()?$(".error").html("E-mail format is incorrect."):$(".error").html("邮箱格式不正确。"));r={"verify_type":a,"email":l,"verify_code":o,"password":e,"school_id":t},i={"verify_type":a,"email":l,"password":e}}r.school_region_id=$("#schoolRegion").children("option:selected").val(),$.ajax({"type":"POST","url":url+"/api/v1/user/register","dataType":"json","data":r,"success":function(e){200===e.code?(isEnglish()?$(".error").html("Registration is successful, Automatic login."):$(".error").html("注册成功，自动登录中。"),setTimeout(function(){$.ajax({"type":"POST","url":url+"/api/v1/user/login","dataType":"json","data":i,"success":function(e){if(200===e.code){var o=api.getUser(e.data.token);getCookie("token",e.data.token,{"expires":1,"path":"/"}),null==o.name&&(o.name=""),getCookie("username",o.name,{"expires":30,"path":"/"}),getCookie("userId",o.id,{"expires":30,"path":"/"}),getCookie("account",l,{"expires":1,"path":"/"});var t=api.getSchool(o.school_info.id,i18nLanguage);null==t.name&&(t.name=""),getCookie("school",t.name,{"expires":30,"path":"/"}),getCookie("schoolId",t.id,{"expires":30,"path":"/"});var r={"token":e.data.token,"user_id":o.id,"reciever_name":l,"reciever_phone":o.phone?o.phone:"","address":o.school_info.name+" "+o.school_region_info.name,"is_default":"y","is_from_school":"y"};$.ajax({"type":"POST","url":url+"/api/v1/address/create","dataType":"json","data":r,"success":function(e){},"error":function(e,o,t){}});var i=getCookie("username");if(getCookie("username").length<=0){var a,n=getCookie("account");a=CheckMobile(n)?n.slice(0,3)+"****"+n.slice(-4):n.split("@")[0].slice(0,-4)+"****@"+n.split("@")[1],isEnglish()?$(".welcome").html("Dear "+a+", Welcome to "+getCookie("school")+" page."):$(".welcome").html("Dear "+a+", 欢迎访问"+getCookie("school")+"专属页面。")}else isEnglish()?$(".welcome").html("Dear "+i+", Welcome to "+getCookie("school")+" page."):$(".welcome").html("Dear "+i+", 欢迎访问"+getCookie("school")+"专属页面。");if(getCookie("localCart")){var c=[];if(getCookie("localCart"))(n=getCookie("localCart")).split(",").forEach(function(e,o){e={"sku_id":e.split("-")[0],"quantity":e.split("-")[1]};c.push(e)});$.ajax({"type":"POST","url":url+"/api/v1/cart/batch-create","dataType":"json","data":{"token":e.data.token,"user_id":o.id,"items":JSON.stringify(c)},"success":function(e){e.code},"error":function(){}})}setTimeout(function(){location.href="index.html"},2e3)}else $(".error").html(e.msg)},"error":function(e,o,t){}})},2e3)):$(".error").html(e.msg)},"error":function(e,o,t){}})}else isEnglish()?$(".error").html("The password is illegal"):$(".error").html("密码不合法，输入5-15位数！");else isEnglish()?$(".error").html("The verification code is not in the correct format."):$(".error").html("验证码格式不正确。")})});