$(function(){login();getCookie("token");$('.radio[name="type"]').click(function(){var e=$(this).val();console.log(e),"self"===e?($(".serCon").hide(),$("#self").show()):"door"===e&&($(".serCon").hide(),$("#door").show())});var t=[],r=[];function a(e,i){$.ajax({"type":"POST","url":url+"/api/v1/system/image-upload","dataType":"json","contentType":!1,"processData":!1,"data":e,"success":function(e){200===e.code&&i(e.data)},"error":function(){}})}function n(e){$(".deviceChild").html(""),$.ajax({"type":"GET","url":url+"/api/v1/category/get?id="+e,"dataType":"json","success":function(e){if(200===e.code){var i=e.data.children;if(0===i.length)return void $(".deviceChild").hide();i.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".deviceChild").append(a),$(".deviceChild").show("")})}},"error":function(){}})}function o(e){$(".faultChild").html(""),$.ajax({"type":"GET","url":url+"/api/v1/category/get?id="+e,"dataType":"json","success":function(e){if(200===e.code){var i=e.data.children;if(0===i.length)return void $(".faultChild").hide();i.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".faultChild").append(a),$(".faultChild").show("")})}},"error":function(){}})}$("#self .file").change(function(){var i=$(this),e=new FormData;e.append("file",$(this).get(0).files[0]),a(e,function(e){i.parent().find(".imgshow").attr("src",e[0].url),i.parent().find(".imgshow").attr("data-name",e[0].id),t.push(e[0].id)})}),$("#door .file").change(function(){var i=$(this),e=new FormData;e.append("file",$(this).get(0).files[0]),a(e,function(e){i.parent().find(".imgshow").attr("src",e[0].url),i.parent().find(".imgshow").attr("data-name",e[0].id),r.push(e[0].id)})}),$.ajax({"type":"GET","url":url+"/api/v1/category/index?type=device","dataType":"json","success":function(e){200===e.code&&e.data.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".device").append(a),0===i&&n(e.id)})},"error":function(){}}),$(".device").bind("change",function(){n($(this).find("option:selected").val())}),$.ajax({"type":"GET","url":url+"/api/v1/category/index?type=fault","dataType":"json","success":function(e){200===e.code&&e.data.forEach(function(e,i){var a='<option value="'+e.id+'">'+e.name+"</option>";$(".fault").append(a),0===i&&o(e.id)})},"error":function(){}}),$(".fault").bind("change",function(){o($(this).find("option:selected").val())}),$("#door .phone").on("change",function(){var e=$(this).val();CheckMobile(e)?($(".error").html(""),api.getRepairInfo(e,function(e){var i=e.device_infos,a=e.coupon_infos;0!==i.length&&i.forEach(function(e,i){$("#sku_id").append('<p><input type="radio" name="addr" id="device4" checked=""><label for="device4"><span>型号：macbook air 序列号：120000 购买时间：2018-05-25</span></label></p>')}),0!==a.length&&($("#user_coupon_id").html(""),a.forEach(function(e,i){var a;a=isEnglish()?'<a href="javascript:;" class="ticket1" data-name="'+e.id+'">\n                        <div class="up">\n                            <div class="img"></div>\n                            <p>'+e.type+'</p>\n                        </div>\n                        <div class="down">\n                            <p>Unused</p>\n                        </div>\n                    </a>':'<a href="javascript:;" class="ticket1" data-name="'+e.id+'">\n                        <div class="up">\n                            <div class="img"></div>\n                            <p>'+{"repair":"维修券"}[e.type]+'</p>\n                        </div>\n                        <div class="down">\n                            <p>未使用</p>\n                        </div>\n                    </a>',$("#user_coupon_id").append(a)}))})):isEnglish()?$(".error").html("Phone format is incorrect."):$(".error").html("手机格式不正确.")});var l=[];$("#user_coupon_id").on("click",".ticket1",function(){if($(this).hasClass("active")){$(this).removeClass("active");var a=$(this);l.forEach(function(e,i){e===a.attr("data-name")&&l.splice(i,1)})}else $(this).addClass("active"),l.push($(this).attr("data-name"))}),$(".submit").click(function(){var e,i=[],a=[],n=$('#type input[name="type"]:checked').val();if("self"===n){i.push($("#self .device option:selected").val()),i.push($("#self .deviceChild option:selected").val()),a.push($("#self .fault option:selected").val()),a.push($("#self .faultChild option:selected").val());var o=$("#self .phone").val();if(!CheckMobile(o))return void(isEnglish()?$(".error").html("Phone format is incorrect."):$(".error").html("手机格式不正确."));0===t.length&&(isEnglish()?$(".error").html("Please upload pictures."):$(".error").html("请上传图片.")),e={"type":n,"device_category":i.join(","),"fault_category":a.join(","),"img_ids":t.join(","),"param":$("#self .param").val(),"sn":$("#self .sn").val(),"description":$("#self .description").val(),"phone":o,"email":$("#self .email").val(),"lang":i18nLanguage}}else{i.push($("#door .device option:selected").val()),i.push($("#door .deviceChild option:selected").val()),a.push($("#door .fault option:selected").val()),a.push($("#door .faultChild option:selected").val());o=$("#door .phone").val();if(!CheckMobile(o))return void(isEnglish()?$(".error").html("Phone format is incorrect."):$(".error").html("手机格式不正确."));0===r.length&&(isEnglish()?$(".error").html("Please upload pictures."):$(".error").html("请上传图片.")),e={"type":n,"device_category":i.join(","),"fault_category":a.join(","),"img_ids":r.join(","),"param":$("#door .param").val(),"sn":$("#door .sn").val(),"description":$("#door .description").val(),"phone":o,"email":$("#door .email").val(),"sku_id":$("#sku_id").attr("data-name"),"user_coupon_id":l.join(","),"lang":i18nLanguage}}$.ajax({"type":"POST","url":url+"/api/v1/repair/create","dataType":"json","data":e,"success":function(e){200===e.code&&(isEnglish()?$(".error").html("Submitted successfully."):$(".error").html("提交成功。"),setTimeout(function(){location.href="index.html"},1e3))},"error":function(){}})})});